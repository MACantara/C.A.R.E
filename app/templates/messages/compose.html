{% extends "base.html" %}

{% block title %}Compose Message - C.A.R.E. System{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('messages.inbox') }}"
                    class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                    <i class="bi bi-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                        <i class="bi bi-envelope-plus text-blue-600 mr-3"></i>
                        Compose Message
                    </h1>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">
                        Send a secure message to another healthcare professional
                    </p>
                </div>
            </div>
        </div>

        <!-- Compose Form -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">New Message</h2>
            </div>

            <form method="POST" action="{{ url_for('messages.send_message') }}" class="p-6 space-y-6">
                <!-- Recipient -->
                <div>
                    <label for="recipient_id" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        To <span class="text-red-500">*</span>
                    </label>
                    <select id="recipient_id" name="recipient_id" required
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        <option value="">Select recipient...</option>
                        {% for recipient in recipients %}
                        <option value="{{ recipient.id }}" {% if reply_data and reply_data.recipient_id==recipient.id
                            %}selected{% endif %}>
                            {{ recipient.first_name }} {{ recipient.last_name }} - {{ recipient.role.title() }}
                            {% if recipient.specialization %} ({{ recipient.specialization }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Subject and Priority Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label for="subject" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Subject <span class="text-red-500">*</span>
                        </label>
                        <input id="subject" name="subject" type="text" required
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                            placeholder="Enter message subject"
                            value="{{ reply_data.subject if reply_data else request.form.subject }}">
                    </div>

                    <div>
                        <label for="priority" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                            Priority
                        </label>
                        <select id="priority" name="priority"
                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            <option value="low" {% if (reply_data and reply_data.priority=='low' ) or
                                request.form.priority=='low' %}selected{% endif %}>Low</option>
                            <option value="normal" {% if (reply_data and reply_data.priority=='normal' ) or
                                request.form.priority=='normal' or (not reply_data and not request.form.priority)
                                %}selected{% endif %}>Normal</option>
                            <option value="high" {% if (reply_data and reply_data.priority=='high' ) or
                                request.form.priority=='high' %}selected{% endif %}>High</option>
                            <option value="urgent" {% if (reply_data and reply_data.priority=='urgent' ) or
                                request.form.priority=='urgent' %}selected{% endif %}>Urgent</option>
                        </select>
                    </div>
                </div>

                <!-- Message Type -->
                <div>
                    <label for="message_type" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Message Type
                    </label>
                    <select id="message_type" name="message_type"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        <option value="general" {% if (reply_data and reply_data.message_type=='general' ) or
                            request.form.message_type=='general' or (not reply_data and not request.form.message_type)
                            %}selected{% endif %}>General</option>
                        <option value="queue_update" {% if (reply_data and reply_data.message_type=='queue_update' ) or
                            request.form.message_type=='queue_update' %}selected{% endif %}>Queue Update</option>
                        <option value="appointment" {% if (reply_data and reply_data.message_type=='appointment' ) or
                            request.form.message_type=='appointment' %}selected{% endif %}>Appointment Related</option>
                        <option value="patient_info" {% if (reply_data and reply_data.message_type=='patient_info' ) or
                            request.form.message_type=='patient_info' %}selected{% endif %}>Patient Information</option>
                    </select>
                </div>

                <!-- Original Message Quote (for replies) -->
                {% if reply_data %}
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 border-l-4 border-blue-500">
                    <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        <i class="bi bi-reply mr-1"></i>In reply to message from {{ reply_data.original_sender }} on {{
                        reply_data.original_date }}:
                    </h4>
                    <div class="text-sm text-gray-600 dark:text-gray-400 italic max-h-32 overflow-y-auto">
                        {{ reply_data.original_content[:300] }}{% if reply_data.original_content|length > 300 %}...{%
                        endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Message Content -->
                <div>
                    <label for="content" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Message <span class="text-red-500">*</span>
                    </label>
                    <textarea id="content" name="content" required rows="8"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 resize-vertical"
                        placeholder="Type your message here...">{{ request.form.content }}</textarea>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        Keep your message professional and concise. All messages are logged for security purposes.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <a href="{{ url_for('messages.inbox') }}"
                        class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-300">
                        Cancel
                    </a>
                    <button type="submit"
                        class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-all duration-300 shadow-lg hover:shadow-xl">
                        <i class="bi bi-send mr-2"></i>
                        Send Message
                    </button>
                </div>
            </form>
        </div>

        <!-- Quick Templates -->
        <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Quick Templates</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Click to use a template</p>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button
                    onclick="useTemplate('Queue Delay Update', 'There has been a delay in the patient queue. Expected delay: [X] minutes. Please adjust patient expectations accordingly.')"
                    class="p-4 text-left border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <h4 class="font-medium text-gray-900 dark:text-white">Queue Delay</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Notify about patient queue delays</p>
                </button>

                <button
                    onclick="useTemplate('Patient Information Request', 'Could you please provide additional information about [Patient Name]? Specifically, I need details about: [specify information needed].')"
                    class="p-4 text-left border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <h4 class="font-medium text-gray-900 dark:text-white">Patient Info Request</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Request patient information</p>
                </button>

                <button
                    onclick="useTemplate('Urgent Consultation Required', 'I need an urgent consultation regarding [Patient Name]. This is time-sensitive. Please contact me when available.')"
                    class="p-4 text-left border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <h4 class="font-medium text-gray-900 dark:text-white">Urgent Consultation</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Request urgent consultation</p>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function useTemplate(subject, content) {
        document.getElementById('subject').value = subject;
        document.getElementById('content').value = content;

        // Set priority and message type based on template
        if (subject.includes('Urgent')) {
            document.getElementById('priority').value = 'urgent';
        } else if (subject.includes('Queue')) {
            document.getElementById('message_type').value = 'queue_update';
            document.getElementById('priority').value = 'high';
        } else if (subject.includes('Patient')) {
            document.getElementById('message_type').value = 'patient_info';
        }

        // Focus on content area for editing
        document.getElementById('content').focus();
    }
</script>
{% endblock %}